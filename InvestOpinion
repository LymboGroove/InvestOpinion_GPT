import feedparser, socket, git, os
from openai import OpenAI
from datetime import datetime

client = OpenAI()

def get_news_headlines_from_rss(feed_urls, max_headlines=20):
    news_list=[]
    for url in feed_urls:
        try:
            # Setting a timeout for the HTTP request
            socket.setdefaulttimeout(10)
            feed = feedparser.parse(url)
            if feed.bozo == 0:
                for entry in feed.entries:
                    news_list.append(entry.title)
        except Exception as e:
            print(f"Failed to fetch from {url}: {e}")
    return news_list
            
def summarize_news(feed_urls):
    summary = []
    news_list = get_news_headlines_from_rss(feed_urls)
    completion = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": "You are a smart and delighted analyst, good at market analysis and economic forecast."},
            {"role": "assistant", "content":str(news_list)},
            {"role": "user", "content": "Based on the list of news on the economy and influence of global environment, describe and explain the potential direction of investment on the market."}
        ]
    )
    summary = completion.choices[0].message
    return summary.content

def save_summaries_to_markdown(summaries):
    # Ensure the export directory exists
    if not os.path.exists("export"):
        os.makedirs("export")
    # Get current date
    current_date = datetime.now().strftime("%Y-%m-%d")
    filename = f"GPT_InvestOpinions_{current_date}.md"
    with open(filename, "w") as file:
        file.write(f"# Investment opinions for {current_date}, generated by OpenAI GPT-4o model.\n \n")
        file.write(f"{summaries}")
        file.write(f"\n\n The content provided is for informational purposes only and should not be considered legal, tax, investment, financial, or other professional advice. Nothing on our site constitutes a solicitation, recommendation, endorsement, or offer by the author, OpenAI or any third-party service provider to buy or sell any securities or financial instruments in any jurisdiction where such actions would be illegal under the local securities laws. \n All content on this site is general information and does not cater to the specific circumstances of any individual or entity. Nothing on the site constitutes professional or financial advice, nor does it offer a comprehensive or complete statement on the topics discussed or related laws. The author and OpenAI is not acting as a fiduciary through anyone's use of or access to the site or content. You are solely responsible for evaluating the merits and risks of using any information or content on the site before making any decisions based on it. By using the site, you agree not to hold the author, OpenAI and its affiliates, or any third-party service provider liable for any damages resulting from decisions made based on the information or content available on the site.")
    return filename

def push_to_github(repo_path, filename):
    repo = git.Repo("https://github.com/LymboGroove/InvestOpinion_GPT.git")
    repo.git.add(filename)
    repo.index.commit(f"Add news summaries for {datetime.now().strftime('%Y-%m-%d')}")
    origin = repo.remote(name='InvestOpinion_GPT')
    origin.push()

RSS_FEED_URLS = [
    'https://feeds.a.dj.com/rss/RSSMarketsMain.xml',
    'https://rss.nytimes.com/services/xml/rss/nyt/Economy.xml',
    'http://rss.cnn.com/rss/money_news_economy.rss',
    'https://www.theguardian.com/world/rss',
    'https://feeds.a.dj.com/rss/RSSWorldNews.xml',
    'http://rss.nytimes.com/services/xml/rss/nyt/World.xml',
]
filename = save_summaries_to_markdown(summarize_news(RSS_FEED_URLS))