import feedparser, socket, git, os
from openai import OpenAI
from datetime import datetime

client = OpenAI()

def get_news_headlines_from_rss(feed_urls, max_headlines=20):
    news_list=[]
    for url in feed_urls:
        try:
            # Setting a timeout for the HTTP request
            socket.setdefaulttimeout(10)
            feed = feedparser.parse(url)
            if feed.bozo == 0:
                for entry in feed.entries:
                    news_list.append(entry.title)
        except Exception as e:
            print(f"Failed to fetch from {url}: {e}")
    return news_list
            
def summarize_news(feed_urls):
    summary = []
    news_list = get_news_headlines_from_rss(feed_urls)
    completion = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": "You are a smart and delighted analyst, good at market analysis and economic forecast. You'll need to consider budgeting, investment strategies and risk management when creating a brief report for your client. In some cases, you may also need to provide advice on taxation laws and regulations in order to help them maximize their profits"},
            {"role": "assistant", "content":str(news_list)},
            {"role": "user", "content": "Based on the list of news on the economy and influence of global environment, describe and explain the potential direction of investment on the market."},
            {"role": "user", "content": "The response should include at least 2 parts for each sector: 1. The analysis of news in each sector, and 2. Recommendation/insight of the investment of each sector. Be creative, there are no limits on the number of sectors you could analyze. After you are done analyzing all the sectors, leave a brief paragraph on the whole market's insight and investment potentials."},
            {"role": "user", "content": "An example of the format would be like:'### Healthcare Sector /n /n #### Analysis: /n - **Alzheimerâ€™s Takes a Financial Toll Long Before Diagnosis, Study Finds**: Highlights the importance and potential growth in healthcare solutions for chronic conditions. /n - **U.A.W. Reaches Accord on Pay and Safety at E.V. Battery Plant**: A healthier working environment for battery plants may reduce long-term healthcare liabilities, indirectly benefiting the healthcare sector. /n /n #### Recommendation: /n Invest in healthcare stocks, particularly those focusing on chronic conditions and innovative treatments. Pharmaceutical companies with a strong R&D pipeline and healthcare tech firms offer long-term growth potential.'"},
            {"role": "user", "content": "Do not include phrases like 'certainly' or 'absolutely'. Do not include any error messages like 'as an AI model...'. Start directly with the tips and make sure the response is concise and straightforward."}
        ]
    )
    summary = completion.choices[0].message
    return summary.content

def save_summaries_to_markdown(summaries):
    export_dir = "export"
    # Ensure the export directory exists
    if not os.path.exists("export"):
        os.makedirs("export")
    # Get current date
    current_date = datetime.now().strftime("%Y-%m-%d")
    filename = f"{export_dir}/GPT_InvestOpinions_{current_date}.md"
    with open(filename, "w") as file:
        file.write(f"# --- \n title: {current_date} Investment opinions generated by OpenAI GPT-4o model \n --- \n \n")
        file.write(f"{summaries}")
        file.write(f"\n\n The content provided is for informational purposes only and should not be considered legal, tax, investment, financial, or other professional advice. Nothing on our site constitutes a solicitation, recommendation, endorsement, or offer by the author, OpenAI or any third-party service provider to buy or sell any securities or financial instruments in any jurisdiction where such actions would be illegal under the local securities laws. \n All content on this site is general information and does not cater to the specific circumstances of any individual or entity. Nothing on the site constitutes professional or financial advice, nor does it offer a comprehensive or complete statement on the topics discussed or related laws. The author and OpenAI is not acting as a fiduciary through anyone's use of or access to the site or content. You are solely responsible for evaluating the merits and risks of using any information or content on the site before making any decisions based on it. By using the site, you agree not to hold the author, OpenAI and its affiliates, or any third-party service provider liable for any damages resulting from decisions made based on the information or content available on the site.")
    return filename

RSS_FEED_URLS = [
    'https://feeds.a.dj.com/rss/RSSMarketsMain.xml',
    'https://rss.nytimes.com/services/xml/rss/nyt/Economy.xml',
    'http://rss.cnn.com/rss/money_news_economy.rss',
    'https://www.theguardian.com/world/rss',
    'https://feeds.a.dj.com/rss/RSSWorldNews.xml',
    'http://rss.nytimes.com/services/xml/rss/nyt/World.xml',
]
filename = save_summaries_to_markdown(summarize_news(RSS_FEED_URLS))